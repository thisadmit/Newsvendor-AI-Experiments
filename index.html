<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Newsvendor AI Experiment</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-color: #2563eb; --bg-color: #f3f4f6; --card-bg: #ffffff; --ai-color: #7c3aed; }
        body { font-family: sans-serif; background: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .progress-container { flex-grow: 1; margin: 0 20px; background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .main-container { display: grid; grid-template-columns: 1fr 1.6fr; gap: 20px; flex-grow: 1; min-height: 0; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        /* AI Advice Box Styles */
        .ai-advice-box { border: 2px solid #ddd6fe; background: #f5f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
        
        .submit-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }
        .submit-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .ai-btn { background: var(--ai-color); margin-bottom: 10px; }
        
        .input-group { margin: 15px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; box-sizing: border-box; }
        
        .chart-container { flex-grow: 1; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; min-height: 250px; position: relative; }
        table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        th { background: #f9fafb; position: sticky; top: 0; padding: 8px; }
        td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="instruction-section" class="card" style="max-width: 700px; margin: 50px auto;">
        <h2>ì‹¤í—˜ ì•ˆë‚´</h2>
        <p>ì¬ê³  ê´€ë¦¬ ë‹´ë‹¹ìë¡œì„œ ì´ 4ê°œì˜ ì„¸ì…˜(ì„¸ì…˜ë‹¹ 10ë¼ìš´ë“œ, ì´ 40ë¼ìš´ë“œ) ë™ì•ˆ ì˜ì‚¬ê²°ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ê° ì„¸ì…˜ë§ˆë‹¤ ë¹„ìš© ì¡°ê±´ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div class="input-group">
            <label for="subject-id">í”¼ì‹¤í—˜ì ê³ ìœ  ì½”ë“œ ì…ë ¥:</label>
            <input type="text" id="subject-id" placeholder="ì˜ˆ: S001" required>
        </div>

        <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p>ğŸ’° íŒë§¤ê°€: 12,000ì› (ê³ ì •)</p>
            <p>ğŸ“ˆ ìˆ˜ìš”ë¶„í¬: ë§¤ ë¼ìš´ë“œ ë³€í™”</p>
            <p>ğŸ¤– ë§¤ ë¼ìš´ë“œ AIì˜ ì¶”ì²œì„ í™•ì¸í•œ í›„ ì£¼ë¬¸ëŸ‰ì„ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <button class="submit-btn" onclick="startExperiment()">ì‹¤í—˜ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="experiment-section" style="display: none;">
        <div class="header">
            <div>ì„¸ì…˜: <b id="current-session">1</b>/4 | ì›ê°€: <b id="header-cost">0</b>ì›</div>
            <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
            <div>ROUND <span id="current-round-display">1</span>/10 | ëˆ„ì  ìˆ˜ìµ: <span id="total-profit">0</span>ì›</div>
        </div>
        <div class="main-container">
            <div class="card">
                <h3>Decision Panel</h3>
                
                <div id="ai-area">
                    <button id="ai-ask-btn" class="submit-btn ai-btn" onclick="revealAIAdvice()">ğŸ¤– Chatbotì—ê²Œ ì¶”ì²œë°›ê¸°</button>
                    <div id="ai-content" class="ai-advice-box" style="display:none;">
                        <div id="ai-loading" style="text-align:center; font-weight:bold; color:var(--ai-color);">
                            <span class="loading-dots">AIê°€ ì‹œì¥ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤</span>
                        </div>
                        <div id="ai-result" style="display:none;">
                            <div style="color:var(--ai-color); font-weight:bold; font-size:1.1rem;">AI ì¶”ì²œëŸ‰: <span id="ai-prediction">-</span>ê°œ</div>
                            <div id="ai-reason-text" style="font-size:0.9rem; margin-top:8px; color:#666;"></div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>ì£¼ë¬¸ëŸ‰ ê²°ì •:</label>
                    <input type="number" id="order-qty" placeholder="ìˆ˜ëŸ‰ ì…ë ¥ í›„ Enter" style="font-size:1.2rem;">
                </div>
                <button class="submit-btn" id="btn-submit" onclick="submitOrder()">ì£¼ë¬¸ ì œì¶œ (Submit)</button>
            </div>

            <div class="card">
                <div class="chart-container"><canvas id="demandChart"></canvas></div>
                <div style="overflow-y:auto; height:200px; border-top:1px solid #eee;">
                    <table id="history-table">
                        <thead><tr><th>Session</th><th>Rnd</th><th>AI</th><th>ë‚˜</th><th>ìˆ˜ìš”</th><th>ìˆ˜ìµ</th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_KEY');

        // ì‹¤í—˜ ìƒíƒœ ë³€ìˆ˜
        let subjectId = "";
        const price = 12000;
        let currentSession = 1;
        let currentRoundInSession = 1;
        let totalRoundCount = 1;
        const roundsPerSession = 10;
        const totalSessions = 4;
        
        let cost, criticalRatio, optimalQ, demandRange;
        let totalProfit = 0;
        const localDataLog = [];

        // 4. ì„¸ì…˜ë³„ í™˜ê²½ ì„¤ì • (ë¼ìš´ë“œë§ˆë‹¤ ë‹¤ë¥´ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ generateNewScenario ë‚´ì—ì„œ ì¡°ì ˆ ê°€ëŠ¥)
        function updateEnvironment() {
            // ì˜ˆì‹œ: ì„¸ì…˜ë³„ë¡œ ì›ê°€ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì • (3000, 6000, 9000, 4500 ë“±)
            const costs = [3000, 9000, 4000, 8000];
            cost = costs[currentSession - 1];
            demandRange = { min: 1, max: 100 };
            
            criticalRatio = (price - cost) / price;
            optimalQ = Math.round(demandRange.min + (demandRange.max - demandRange.min) * criticalRatio);
            
            document.getElementById('header-cost').innerText = cost.toLocaleString();
            document.getElementById('current-session').innerText = currentSession;
        }

        function startExperiment() {
            subjectId = document.getElementById('subject-id').value.trim();
            if (!subjectId) return alert("ê³ ìœ  ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            document.getElementById('instruction-section').style.display = 'none';
            document.getElementById('experiment-section').style.display = 'block';
            
            updateEnvironment();
            generateNewScenario();
            drawChart();
        }

        function generateNewScenario() {
            // ë§¤ ë¼ìš´ë“œ ìƒˆë¡œìš´ ìˆ˜ìš” ìƒì„±
            const actualDemand = Math.floor(Math.random() * (demandRange.max - demandRange.min + 1)) + demandRange.min;
            window.currentScenario = { ai: optimalQ, actual: actualDemand };
            
            // ì´ˆê¸°í™”: AI ì¶”ì²œ ìˆ¨ê¸°ê¸°
            document.getElementById('ai-ask-btn').style.display = 'block';
            document.getElementById('ai-content').style.display = 'none';
            document.getElementById('ai-result').style.display = 'none';
            document.getElementById('ai-loading').style.display = 'block';
            
            document.getElementById('order-qty').value = '';
            document.getElementById('order-qty').focus();
            document.getElementById('current-round-display').innerText = currentRoundInSession;
        }

        // 3. AI ì¶”ì²œ ë¡œì§ (5ì´ˆ ì§€ì—°)
        function revealAIAdvice() {
            document.getElementById('ai-ask-btn').style.display = 'none';
            document.getElementById('ai-content').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-result').style.display = 'block';
                document.getElementById('ai-prediction').innerText = window.currentScenario.ai;
                document.getElementById('ai-reason-text').innerHTML = 
                    `í˜„ì¬ ì›ê°€(${cost.toLocaleString()}ì›)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚°ì¶œëœ<br>ìµœì  ì„ê³„ì¹˜(Critical Ratio)ëŠ” ${Math.round(criticalRatio*100)}%ì…ë‹ˆë‹¤.<br>ì´ ìˆ˜ì¹˜ë¥¼ ì ìš©í•œ ì¶”ì²œ ìˆ˜ëŸ‰ì€ ${window.currentScenario.ai}ê°œì…ë‹ˆë‹¤.`;
            }, 5000); // 5ì´ˆ ëŒ€ê¸°
        }

        function submitOrder() {
            const qty = parseInt(document.getElementById('order-qty').value);
            if (isNaN(qty) || qty < 0) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const demand = window.currentScenario.actual;
            const profit = (Math.min(qty, demand) * price) - (qty * cost);
            totalProfit += profit;

            // ë°ì´í„° ê¸°ë¡ (subject_id í¬í•¨)
            localDataLog.push({
                subject_id: subjectId,
                session_number: currentSession,
                round_in_session: currentRoundInSession,
                total_round: totalRoundCount,
                cost: cost,
                ai_recommendation: window.currentScenario.ai,
                user_order: qty,
                actual_demand: demand,
                profit: profit,
                accumulated_profit: totalProfit,
                timestamp: new Date().toISOString()
            });

            updateUI(qty, demand, profit);
            
            // ë¼ìš´ë“œ ë° ì„¸ì…˜ ê´€ë¦¬
            if (currentRoundInSession < roundsPerSession) {
                currentRoundInSession++;
                totalRoundCount++;
                document.getElementById('progress-bar').style.width = (totalRoundCount / (totalSessions * roundsPerSession) * 100) + "%";
                generateNewScenario();
                drawChart();
            } else if (currentSession < totalSessions) {
                alert(`ì„¸ì…˜ ${currentSession}ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í™•ì¸ì„ ëˆ„ë¥´ë©´ ë‹¤ìŒ ì„¸ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.`);
                currentSession++;
                currentRoundInSession = 1;
                totalRoundCount++;
                updateEnvironment();
                generateNewScenario();
                drawChart();
            } else {
                saveAllDataToSupabase();
            }
        }

        function updateUI(qty, demand, profit) {
            const row = `<tr>
                <td>${currentSession}</td>
                <td>${currentRoundInSession}</td>
                <td>${window.currentScenario.ai}</td>
                <td>${qty}</td>
                <td>${demand}</td>
                <td>${profit.toLocaleString()}</td>
            </tr>`;
            document.getElementById('history-table-body').insertAdjacentHTML('afterbegin', row);
            document.getElementById('total-profit').innerText = totalProfit.toLocaleString();
        }

        async function saveAllDataToSupabase() {
            const btn = document.getElementById('btn-submit');
            btn.innerText = "ë°ì´í„° ì €ì¥ ì¤‘...";
            btn.disabled = true;

            const { error } = await _supabase.from('experiment_results').insert(localDataLog);

            if (error) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + error.message);
                btn.disabled = false;
            } else {
                alert("âœ… ëª¨ë“  ì‹¤í—˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!");
                // window.location.href = "FINISH_PAGE_URL";
            }
        }

        // ì°¨íŠ¸ ë“œë¡œì‰ (ì „ì²´ ë¼ìš´ë“œ íë¦„ ì‹œê°í™”)
        function drawChart() {
            const canvas = document.getElementById('demandChart');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.clientWidth;
            const h = canvas.height = canvas.parentElement.clientHeight;
            const pad = 40;
            const totalRounds = totalSessions * roundsPerSession;
            const xStep = (w - pad * 2) / (totalRounds - 1);
            const getY = (v) => h - pad - (v / 120 * (h - pad * 2));

            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = "#eee";
            for(let v=0; v<=100; v+=20) {
                const y = getY(v);
                ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.stroke();
                ctx.fillStyle="#999"; ctx.font="10px Arial"; ctx.fillText(v, 10, y+4);
            }
            if (localDataLog.length === 0) return;
            
            const drawLine = (key, color, isDash=false) => {
                ctx.beginPath(); ctx.strokeStyle = color; ctx.setLineDash(isDash ? [5, 5] : []);
                localDataLog.forEach((d, i) => {
                    const x = pad + (i * xStep), y = getY(d[key]);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };
            drawLine('actual_demand', "#1f2937");
            drawLine('ai_recommendation', "#7c3aed", true);
            drawLine('user_order', "#2563eb");
        }

        document.getElementById('order-qty').addEventListener('keypress', (e) => { if(e.key === 'Enter') submitOrder(); });
    </script>
</body>
</html>
