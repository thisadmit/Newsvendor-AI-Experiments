<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsvendor Experiment - Production Version</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2563eb; --bg-color: #f3f4f6; --card-bg: #ffffff;
            --text-main: #1f2937; --text-sub: #6b7280; --success: #10b981;
            --danger: #ef4444; --ai-color: #7c3aed; --ai-bg: #f5f3ff; --ai-border: #ddd6fe;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .progress-container { flex-grow: 1; margin: 0 20px; background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .main-container { display: grid; grid-template-columns: 1fr 1.6fr; gap: 20px; flex-grow: 1; min-height: 0; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        h2 { margin-top: 0; font-size: 1.1rem; color: var(--text-sub); text-transform: uppercase; }
        .ai-advice-box { border: 2px solid var(--ai-border); background: var(--ai-bg); padding: 20px; border-radius: 8px; position: relative; margin-bottom: 20px; }
        .ai-badge { position: absolute; top: -10px; left: 15px; background: var(--ai-color); color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .ai-reason { margin-top: 10px; padding: 12px; background: #ede9fe; border-radius: 6px; font-size: 0.95rem; color: #4c1d95; border-left: 3px solid var(--ai-color); }
        .input-group input { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; transition: opacity 0.2s; }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .chart-container { flex-grow: 1; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; position: relative; min-height: 250px; }
        .history-log { height: 200px; overflow-y: auto; border-top: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; border-bottom: 1px solid #f3f4f6; text-align: left; }
    </style>
</head>
<body>

    <div class="header">
        <div class="round-info">ROUND <span id="current-round">1</span> / 15</div>
        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
        <div class="score-info">ëˆ„ì  ìˆ˜ìµ: <span id="total-profit">0</span> ì›</div>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Decision Context</h2>
            <div style="background:#eff6ff; padding:15px; border-left:4px solid var(--primary-color); border-radius:4px; margin-bottom:20px;">
                <div style="margin:5px 0;">ğŸ›’ ì œí’ˆ íŒë§¤ê°€: <strong>12,000ì›</strong></div>
                <div style="margin:5px 0;">ğŸ“¦ ì œí’ˆ ì›ê°€: <strong>3,000ì›</strong></div>
            </div>

            <div class="ai-advice-box">
                <span class="ai-badge">AI Algorithm Advice</span>
                <div style="font-size: 1.1rem;">AI ì¶”ì²œ ì£¼ë¬¸ëŸ‰: <strong style="font-size: 1.6rem; color: #7c3aed;" id="ai-prediction">-</strong> ê°œ</div>
                <div class="ai-reason" id="ai-reason-text">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
            </div>

            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-weight:bold;">ìµœì¢… ì£¼ë¬¸ëŸ‰ ì…ë ¥ (Order Quantity)</label>
                <input type="number" id="order-qty" placeholder="ìˆ˜ëŸ‰ ì…ë ¥">
                <button class="submit-btn" id="main-submit-btn" onclick="submitOrder()">ì£¼ë¬¸ ì œì¶œ (Submit)</button>
            </div>
        </div>

        <div class="card">
            <h2>Demand History & Feedback</h2>
            <div class="chart-container"><canvas id="demandChart"></canvas></div>
            <div class="history-log">
                <table>
                    <thead><tr><th>Rnd</th><th>AIì¶”ì²œ</th><th>ë‚´ì£¼ë¬¸</th><th>ì‹¤ìˆ˜ìš”</th><th>ì˜¤ì°¨</th><th>ìˆ˜ìµ</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 1. Supabase ì„¤ì •
        const _supabase = supabase.createClient('https://rrbiyvcjtqvdfhudagnk.supabase.co', 'sb_publishable_pWpbnjDOm4LihZ8k720qhA_VPCRcCnV');

        // 2. ì‹¤í—˜ ìƒìˆ˜ ë° ë³€ìˆ˜
        let currentRound = 1;
        const maxRounds = 15;
        let totalProfit = 0;
        const price = 12000, cost = 3000, salvage = 0;

        const urlParams = new URLSearchParams(window.location.search);
        const prolificID = urlParams.get('prolific_pid') || "test_" + Math.random().toString(36).substr(2, 5);

        const historyData = { rounds: [], aiPreds: [], userOrders: [], actualDemands: [] };

        // 3. ì‹¤ì œ ìˆ˜ìš” ìƒì„± (Box-Muller Transform ì •ê·œë¶„í¬)
        function getActualDemand() {
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); 
            while(v === 0) v = Math.random();
            const rand = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return Math.max(50, Math.round(150 + (30 * rand)));
        }

        function generateNewScenario() {
            const actual = getActualDemand();
            const aiPred = Math.round(actual + (Math.random() * 30 - 15)); // AIëŠ” ì‹¤ì œ ìˆ˜ìš” ê·¼ì²˜ì—ì„œ ë…¸ì´ì¦ˆ í¬í•¨ ì¶”ì²œ
            document.getElementById('ai-prediction').innerText = aiPred;
            
            const reasons = [
                "ê³¼ê±° 3ì£¼ê°„ì˜ íŒë§¤ëŸ‰ê³¼ ê³„ì ˆì  ìš”ì¸ì„ ë°˜ì˜í•œ ìµœì ì¹˜ì…ë‹ˆë‹¤.",
                "ì¬ê³  ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ ê¸°íšŒ ë¹„ìš©ì„ ìµœì†Œí™”í•˜ë„ë¡ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "ìµœê·¼ ì‹œì¥ì˜ ë³€ë™ì„±ì„ ê³ ë ¤í•˜ì—¬ ë³´ìˆ˜ì ìœ¼ë¡œ ì‚°ì¶œëœ ê²°ê³¼ì…ë‹ˆë‹¤.",
                "ìœ ì‚¬í•œ ê°€ê²©ëŒ€ì˜ ê³¼ê±° ë°ì´í„°ë¥¼ í•™ìŠµí•œ ì•Œê³ ë¦¬ì¦˜ì˜ ì¶”ì²œê°’ì…ë‹ˆë‹¤."
            ];
            document.getElementById('ai-reason-text').innerText = reasons[Math.floor(Math.random()*reasons.length)];

            window.currentScenario = { ai: aiPred, actual: actual };
            const input = document.getElementById('order-qty');
            input.value = '';
            input.focus();
        }

        async function submitOrder() {
            const input = document.getElementById('order-qty');
            const qty = parseInt(input.value);
            if (isNaN(qty) || qty < 0) return alert("ìœ íš¨í•œ ì£¼ë¬¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

            const demand = window.currentScenario.actual;
            const sold = Math.min(qty, demand);
            const roundProfit = (sold * price) - (qty * cost);
            totalProfit += roundProfit;

            // ë°ì´í„° ê¸°ë¡
            historyData.rounds.push(currentRound);
            historyData.aiPreds.push(window.currentScenario.ai);
            historyData.userOrders.push(qty);
            historyData.actualDemands.push(demand);

            updateHistoryTable(currentRound, window.currentScenario.ai, qty, demand, roundProfit);
            drawChart();

            if (currentRound < maxRounds) {
                currentRound++;
                updateRoundUI();
                generateNewScenario();
            } else {
                await saveToSupabase();
            }
        }

        function updateRoundUI() {
            document.getElementById('current-round').innerText = currentRound;
            document.getElementById('total-profit').innerText = totalProfit.toLocaleString();
            document.getElementById('progress-bar').style.width = ((currentRound-1)/maxRounds*100) + "%";
        }

        function updateHistoryTable(rnd, ai, order, actual, profit) {
            const tbody = document.getElementById('history-table-body');
            const error = order - actual;
            const errorStyle = error === 0 ? "color:green" : "color:red";
            const errorText = error === 0 ? "ì •í™•í•¨" : (error > 0 ? `+${error} (ê³¼ì‰)` : `${error} (ë¶€ì¡±)`);
            
            const row = `<tr>
                <td>${rnd}</td>
                <td style="color:#7c3aed; font-weight:bold;">${ai}</td>
                <td style="font-weight:bold;">${order}</td>
                <td style="font-weight:bold;">${actual}</td>
                <td style="${errorStyle}">${errorText}</td>
                <td>${profit.toLocaleString()}</td>
            </tr>`;
            tbody.insertAdjacentHTML('afterbegin', row);
        }

        async function saveToSupabase() {
            const btn = document.getElementById('main-submit-btn');
            btn.innerText = "ë°ì´í„° ì „ì†¡ ì¤‘...";
            btn.disabled = true;

            const { error } = await _supabase.from('experiment_results').insert([{
                prolific_id: prolificID,
                total_profit: totalProfit,
                user_orders: historyData.userOrders.toString(),
                actual_demands: historyData.actualDemands.toString(),
                ai_recommendations: historyData.aiPreds.toString()
            }]);

            if (error) {
                console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                alert("âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + error.message + "\ní™”ë©´ì„ ìº¡ì²˜í•œ í›„ ì—°êµ¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                btn.innerText = "ì €ì¥ ì¬ì‹œë„";
                btn.disabled = false;
            } else {
                alert("âœ… ì‹¤í—˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në°ì´í„°ê°€ ì„œë²„(Supabase)ë¡œ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                // Prolific ì™„ë£Œ í˜ì´ì§€ë¡œ ìë™ ì´ë™ ì„¤ì • ì‹œ ì•„ë˜ ì£¼ì„ í•´ì œ
                // window.location.href = "https://app.prolific.com/submissions/complete?cc=YOUR_CODE";
            }
        }

        function drawChart() {
            const canvas = document.getElementById('demandChart');
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            const w = canvas.width = container.clientWidth;
            const h = canvas.height = container.clientHeight;
            const pad = 40;

            ctx.clearRect(0, 0, w, h);
            if (historyData.rounds.length === 0) return;

            const maxVal = 250, minVal = 50; // ê³ ì • ìŠ¤ì¼€ì¼
            const xStep = (w - pad * 2) / (maxRounds - 1);
            const getY = (val) => h - pad - ((val - minVal) / (maxVal - minVal) * (h - pad * 2));

            // Grid Lines
            ctx.strokeStyle = "#e5e7eb"; ctx.lineWidth = 1;
            for(let v=50; v<=250; v+=50) {
                const y = getY(v);
                ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-pad, y); ctx.stroke();
                ctx.fillStyle = "#9ca3af"; ctx.font = "10px Arial";
                ctx.fillText(v, 5, y + 4);
            }

            const drawLine = (data, color, isDash=false) => {
                ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2.5;
                if(isDash) ctx.setLineDash([5, 5]); else ctx.setLineDash([]);
                data.forEach((v, i) => {
                    const x = pad + (i * xStep), y = getY(v);
                    if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                data.forEach((v, i) => {
                    const x = pad + (i * xStep), y = getY(v);
                    ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = "white"; ctx.lineWidth = 1; ctx.stroke();
                });
            };

            drawLine(historyData.actualDemands, "#1f2937");    // ì‹¤ì œ ìˆ˜ìš” (ê²€ì • ì‹¤ì„ )
            drawLine(historyData.aiPreds, "#7c3aed", true);   // AI ì¶”ì²œ (ë³´ë¼ ì ì„ )
            drawLine(historyData.userOrders, "#2563eb");     // ë‚´ ì£¼ë¬¸ (íŒŒë‘ ì‹¤ì„ )
        }

        window.onload = () => { generateNewScenario(); updateRoundUI(); drawChart(); };
    </script>
</body>
</html>
