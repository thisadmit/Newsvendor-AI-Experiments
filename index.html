<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsvendor Experiment - AI Reason Added</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #2563eb; --bg-color: #f3f4f6; --card-bg: #ffffff;
            --text-main: #1f2937; --text-sub: #6b7280; --success: #10b981;
            --danger: #ef4444; --ai-color: #7c3aed; --ai-bg: #f5f3ff; --ai-border: #ddd6fe;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .progress-container { flex-grow: 1; margin: 0 20px; background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .main-container { display: grid; grid-template-columns: 1fr 1.6fr; gap: 20px; flex-grow: 1; min-height: 0; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .ai-advice-box { border: 2px solid var(--ai-border); background: var(--ai-bg); padding: 20px; border-radius: 8px; position: relative; margin-bottom: 20px; }
        .ai-badge { position: absolute; top: -10px; left: 15px; background: var(--ai-color); color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .ai-reason { margin-top: 10px; padding: 12px; background: #ede9fe; border-radius: 6px; font-size: 0.95rem; color: #4c1d95; border-left: 3px solid var(--ai-color); }
        .input-group input { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .chart-container { flex-grow: 1; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; position: relative; min-height: 250px; }
        .history-log { height: 200px; overflow-y: auto; border-top: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 10px; border-bottom: 1px solid #f3f4f6; text-align: left; }
    </style>
</head>
<body>

    <div class="header">
        <div class="round-info">ROUND <span id="current-round">1</span> / 15</div>
        <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
        <div class="score-info">ëˆ„ì  ìˆ˜ìµ: <span id="total-profit">0</span> ì›</div>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Decision Context</h2>
            <div style="background:#eff6ff; padding:15px; border-left:4px solid var(--primary-color); border-radius:4px; margin-bottom:20px;">
                <div style="margin:5px 0;">ğŸ›’ ì œí’ˆ íŒë§¤ê°€: 12,000ì›</div>
                <div style="margin:5px 0;">ğŸ“¦ ì œí’ˆ ì›ê°€: 3,000ì›</div>
            </div>

            <div class="ai-advice-box">
                <span class="ai-badge">AI Algorithm Advice</span>
                <div style="font-size: 1.1rem;">AI ì¶”ì²œ ì£¼ë¬¸ëŸ‰: <strong style="font-size: 1.6rem; color: #7c3aed;" id="ai-prediction">-</strong> ê°œ</div>
                <div class="ai-reason" id="ai-reason-text">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
            </div>

            <div class="input-group">
                <label style="display:block; margin-bottom:8px; font-weight:bold;">ìµœì¢… ì£¼ë¬¸ëŸ‰ ì…ë ¥</label>
                <input type="number" id="order-qty" placeholder="ì˜ˆ: 150">
                <button class="submit-btn" onclick="submitOrder()">ì£¼ë¬¸ ì œì¶œ (Submit)</button>
            </div>
        </div>

        <div class="card">
            <h2>Demand History & Feedback</h2>
            <div class="chart-container"><canvas id="demandChart"></canvas></div>
            <div class="history-log">
                <table>
                    <thead><tr><th>Rnd</th><th>AIì¶”ì²œ</th><th>ë‚´ì£¼ë¬¸</th><th>ì‹¤ìˆ˜ìš”</th><th>ì˜¤ì°¨</th><th>ìˆ˜ìµ</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 1. Supabase ì´ˆê¸°í™”
        const _supabase = supabase.createClient('https://rrbiyvcjtqvdfhudagnk.supabase.co', 'sb_publishable_pWpbnjDOm4LihZ8k720qhA_VPCRcCnV');

        // 2. ì‹¤í—˜ ë³€ìˆ˜
        let currentRound = 1;
        const maxRounds = 15;
        let totalProfit = 0;
        const price = 12000, cost = 3000, salvage = 0;

        const urlParams = new URLSearchParams(window.location.search);
        const prolificID = urlParams.get('prolific_pid') || "test_" + Math.random().toString(36).substr(2, 5);

        const historyData = { rounds: [], aiPreds: [], userOrders: [], actualDemands: [] };

        // 3. ì‹¤ì œ ìˆ˜ìš” ìƒì„± (í‰ê·  150, í‘œì¤€í¸ì°¨ 30)
        function getActualDemand() {
            let u = 0, v = 0;
            while(u === 0) u = Math.random(); 
            while(v === 0) v = Math.random();
            const rand = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return Math.max(50, Math.round(150 + (30 * rand)));
        }

        function generateNewScenario() {
            const actual = getActualDemand();
            const aiPred = Math.round(actual + (Math.random() * 30 - 15));
            document.getElementById('ai-prediction').innerText = aiPred;
            
            const reasons = ["ê³¼ê±° íŒë§¤ ì¶”ì´ë¥¼ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.", "ì¬ê³  ë¶€ì¡± ë¹„ìš©ì„ ê³ ë ¤í•œ ì¶”ì²œëŸ‰ì…ë‹ˆë‹¤.", "í˜„ì¬ ì‹œì¥ ë³€ë™ì„±ì„ ë°˜ì˜í•˜ì˜€ìŠµë‹ˆë‹¤."];
            document.getElementById('ai-reason-text').innerText = reasons[Math.floor(Math.random()*reasons.length)];

            window.currentScenario = { ai: aiPred, actual: actual };
            document.getElementById('order-qty').value = '';
            document.getElementById('order-qty').focus();
        }

        async function submitOrder() {
            const input = document.getElementById('order-qty');
            const qty = parseInt(input.value);
            if (isNaN(qty) || qty < 0) return alert("ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const demand = window.currentScenario.actual;
            const profit = (Math.min(qty, demand) * price) - (qty * cost);
            totalProfit += profit;

            historyData.rounds.push(currentRound);
            historyData.aiPreds.push(window.currentScenario.ai);
            historyData.userOrders.push(qty);
            historyData.actualDemands.push(demand);

            updateHistoryTable(currentRound, window.currentScenario.ai, qty, demand, profit);
            drawChart();

            if (currentRound < maxRounds) {
                currentRound++;
                updateRoundUI();
                generateNewScenario();
            } else {
                await saveToSupabase();
            }
        }

        function updateRoundUI() {
            document.getElementById('current-round').innerText = currentRound;
            document.getElementById('total-profit').innerText = totalProfit.toLocaleString();
            document.getElementById('progress-bar').style.width = ((currentRound-1)/maxRounds*100) + "%";
        }

        function updateHistoryTable(rnd, ai, order, actual, profit) {
            const tbody = document.getElementById('history-table-body');
            const error = order - actual;
            const errorText = error === 0 ? "ì •í™•" : (error > 0 ? `+${error} ê³¼ì‰` : `${error} ë¶€ì¡±`);
            const row = `<tr><td>${rnd}</td><td>${ai}</td><td>${order}</td><td>${actual}</td><td>${errorText}</td><td>${profit.toLocaleString()}</td></tr>`;
            tbody.insertAdjacentHTML('afterbegin', row);
        }

        async function saveToSupabase() {
            const { error } = await _supabase.from('experiment_results').insert([{
                prolific_id: prolificID,
                total_profit: totalProfit,
                user_orders: historyData.userOrders.toString(),
                actual_demands: historyData.actualDemands.toString(),
                ai_recommendations: historyData.aiPreds.toString()
            }]);

            if (error) {
                alert("ì €ì¥ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í™”ë©´ì„ ìº¡ì²˜í•´ ì£¼ì„¸ìš”.");
