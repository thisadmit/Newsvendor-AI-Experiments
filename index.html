<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Newsvendor AI Experiment</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-color: #2563eb; --bg-color: #f3f4f6; --card-bg: #ffffff; --ai-color: #7c3aed; --error-color: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; }
        
        /* Layout */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .progress-container { flex-grow: 1; margin: 0 20px; background: #e5e7eb; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .main-container { display: grid; grid-template-columns: 1fr 1.6fr; gap: 20px; flex-grow: 1; min-height: 0; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Elements */
        .instruction-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; margin: 15px 0; line-height: 1.6; font-size: 0.95rem; }
        .ai-advice-box { border: 2px solid #ddd6fe; background: #f5f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; min-height: 120px; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }
        .ai-btn { background: var(--ai-color); margin-bottom: 10px; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
        
        /* Warning Message */
        #warning-msg { color: var(--error-color); font-size: 0.85rem; font-weight: bold; margin-top: 5px; min-height: 1.2rem; transition: opacity 0.3s; opacity: 0; }

        /* Chart & Table */
        .chart-container { flex-grow: 1; background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; min-height: 250px; position: relative; }
        table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; }

        /* Modal Styles */
        #session-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; }
        .change-item { display: flex; justify-content: space-around; align-items: center; margin: 15px 0; padding: 15px; background: #f9fafb; border-radius: 12px; min-height: 60px; }
        .old-val { color: #94a3b8; text-decoration: line-through; font-size: 1.1rem; }
        .new-val { color: var(--primary-color); font-weight: bold; font-size: 1.3rem; }
        .no-change { color: #64748b; font-weight: normal; font-size: 1.1rem; width: 100%; text-align: center; }
        .arrow { font-size: 1.5rem; color: #cbd5e1; }
    </style>
</head>
<body>

    <div id="session-modal">
        <div class="modal-content">
            <h2 id="modal-title">ì„¸ì…˜ ì¢…ë£Œ</h2>
            <p style="color: #64748b; margin-bottom: 25px;">ë‹¤ìŒ ì„¸ì…˜ ì‹œì¥ í™˜ê²½ ë³€í™” ì•ˆë‚´</p>
            <div style="text-align: left; font-weight: bold; margin-left: 10px;">ğŸ’° ì›ê°€(Cost) ë³€í™”</div>
            <div class="change-item" id="cost-box"></div>
            <div style="text-align: left; font-weight: bold; margin-left: 10px;">ğŸ“ˆ ìˆ˜ìš” ë²”ìœ„(Demand) ë³€í™”</div>
            <div class="change-item" id="dist-box"></div>
            <button class="submit-btn" onclick="closeModal()">í™•ì¸ ë° ë‹¤ìŒ ì„¸ì…˜ ì‹œì‘</button>
        </div>
    </div>

    <div id="instruction-section" class="card" style="max-width: 800px; margin: 30px auto;">
        <h2 style="margin-top:0;">ğŸ“Š ì¬ê³  ê´€ë¦¬ ì˜ì‚¬ê²°ì • ì‹¤í—˜ ì•ˆë‚´</h2>
        <div class="instruction-box">
            <p>ë³¸ ì‹¤í—˜ì—ì„œëŠ” ì¬ê³  ê´€ë¦¬ ë‹´ë‹¹ìê°€ ë˜ì–´ ìƒí’ˆì˜ <b>ì£¼ë¬¸ëŸ‰</b>ì„ ê²°ì •í•©ë‹ˆë‹¤.</p>
            <ul>
                <li><b>ì‹¤í—˜ êµ¬ì¡°:</b> ì´ 4ê°œì˜ ì„¸ì…˜ì´ ì§„í–‰ë˜ë©°, ê° ì„¸ì…˜ì€ 10ë¼ìš´ë“œë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.</li>
                <li><b>ìˆ˜ìµ ê³„ì‚°:</b> íŒë§¤ ìˆ˜ìµì—ì„œ êµ¬ë§¤ ì›ê°€ë¥¼ ëº€ ê¸ˆì•¡ì´ ë¼ìš´ë“œ ìˆ˜ìµì´ ë©ë‹ˆë‹¤. <br><small>(íŒë§¤ê°€ 12,000ì› ê³ ì • / íŒ”ë¦¬ì§€ ì•Šì€ ì¬ê³ ëŠ” 0ì› ì²˜ë¦¬)</small></li>
                <li><b>ì¡°ê±´ ë³€í™”:</b> ê° ì„¸ì…˜ë§ˆë‹¤ ìƒí’ˆì˜ <b>ì›ê°€</b>ì™€ <b>ìˆ˜ìš” ë°œìƒ ë²”ìœ„</b>ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤.</li>
                <li><b>AI ì¶”ì²œ:</b> ë§¤ ì„¸ì…˜ ì‹œì‘ ì‹œ aië¥¼ í†µí•´ ì¶”ì²œ ìˆ˜ëŸ‰ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œë²ˆ í™•ì¸í•œ ì¶”ì²œì€ í•´ë‹¹ ì„¸ì…˜ ë‚´ë‚´ ìœ ì§€ë©ë‹ˆë‹¤.</li>
            </ul>
        </div>
        <div style="margin-top: 10px;">
            <label style="display:block; font-weight:bold; margin-bottom:8px;">í”¼ì‹¤í—˜ì ê³ ìœ  ì½”ë“œ (Subject ID):</label>
            <input type="text" id="subject-id" placeholder="IDë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”.">
        </div>
        <button class="submit-btn" id="start-btn">ì§€ì¹¨ì„ ì´í•´í–ˆìŠµë‹ˆë‹¤. ì‹¤í—˜ ì‹œì‘</button>
    </div>

    <div id="experiment-section" style="display: none;">
        <div class="header">
            <div>ì„¸ì…˜: <b id="current-session">1</b>/4 | ì›ê°€: <b id="header-cost">0</b>ì› | ìˆ˜ìš”: <b id="header-dist">U[?,?]</b></div>
            <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
            <div>ROUND <span id="current-round-display">1</span>/10 | ëˆ„ì  ìˆ˜ìµ: <span id="total-profit">0</span>ì›</div>
        </div>
        <div class="main-container">
            <div class="card">
                <h3>Decision Panel</h3>
                <div id="ai-area">
                    <button id="ai-ask-btn" class="submit-btn ai-btn">ğŸ¤– AIì—ê²Œ ì„¸ì…˜ ì „ëµ ë¬»ê¸°</button>
                    <div id="ai-content" class="ai-advice-box" style="display:none;">
                        <div id="ai-loading">
                            <span id="loading-text" style="font-weight:bold; color:var(--ai-color);">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘</span><span class="loading-dots"></span>
                        </div>
                        <div id="ai-result" style="display:none;">
                            <div style="color:var(--ai-color); font-weight:bold; font-size:1.1rem; margin-bottom:5px;">AI ì¶”ì²œ ì£¼ë¬¸ëŸ‰: <span id="ai-prediction">-</span>ê°œ</div>
                            <div id="ai-reason-text" style="font-size:0.88rem; color:#4b5563; line-height:1.5;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label style="display:block; font-weight:bold; margin-bottom:8px;">ì´ë²ˆ ë¼ìš´ë“œ ì£¼ë¬¸ ìˆ˜ëŸ‰:</label>
                    <input type="number" id="order-qty" placeholder="ìˆ˜ëŸ‰ ì…ë ¥">
                    <div id="warning-msg"></div> </div>
                <button class="submit-btn" id="btn-submit">ì£¼ë¬¸ ì œì¶œ (Submit)</button>
            </div>
            <div class="card">
                <div class="chart-container"><canvas id="demandChart"></canvas></div>
                <div style="overflow-y:auto; height:200px; border-top:1px solid #eee;">
                    <table>
                        <thead><tr><th>Sess</th><th>Rnd</th><th>AI</th><th>ë‚˜</th><th>ìˆ˜ìš”</th><th>ìˆ˜ìµ</th></tr></thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let _supabase, subjectId = "", currentSession = 1, currentRoundInSession = 1, totalRoundCount = 1;
        const roundsPerSession = 10, totalSessions = 4, price = 12000;
        let cost, optimalQ, minD, maxD, sessionAiReason = "", totalProfit = 0;
        let isAiRevealedThisSession = false; 
        const localDataLog = [];

        document.addEventListener('DOMContentLoaded', () => {
            try {
                _supabase = supabase.createClient('https://rrbiyvcjtqvdfhudagnk.supabase.co', 'sb_publishable_pWpbnjDOm4LihZ8k720qhA_VPCRcCnV');
            } catch(e) { console.error("Supabase ë¡œë“œ ì‹¤íŒ¨:", e); }
            document.getElementById('start-btn').onclick = startExperiment;
            document.getElementById('ai-ask-btn').onclick = revealAIAdvice;
            document.getElementById('btn-submit').onclick = submitOrder;
            document.getElementById('subject-id').onkeypress = (e) => { if(e.key === 'Enter') startExperiment(); };
            document.getElementById('order-qty').onkeypress = (e) => { if(e.key === 'Enter') submitOrder(); };
        });

        function updateEnvironment() {
            const costs = [3000, 9000, 3000, 9000];
            const dists = [{min:1, max:100}, {min:1, max:100}, {min:300, max:500}, {min:300, max:500}];
            cost = costs[currentSession - 1];
            minD = dists[currentSession - 1].min;
            maxD = dists[currentSession - 1].max;
            const criticalRatio = (price - cost) / price;
            optimalQ = Math.round(minD + (maxD - minD) * criticalRatio);
            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()}ì›</b>ì´ë©° ìˆ˜ìš” ë²”ìœ„ëŠ” <b>${minD}~${maxD            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()}            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()            sessionAiReason = `í˜„ì¬ ì„¸ì…˜ ì›ê°€ëŠ” <b>${cost.toLocaleString()}/b>ì…ë‹ˆë‹¤. 1) í™•ë¥ ì  ë°ì´í„° ë¶„ì„ ê²°ê³¼ ... 2) ìˆ˜ìµ ì¤‘ì‹¬ ë¶„ì„ê²°ê³¼, ìˆ˜ìµì„ ê·¹ëŒ€í™”í•˜ê¸° ìœ„í•œ .... ìµœì  ì£¼ë¬¸ëŸ‰ì€ <b>${optimalQ}ê°œ</b>ì…ë‹ˆë‹¤.`;
            isAiRevealedThisSession = false;
            resetAiUI();
            document.getElementById('header-cost').innerText = cost.toLocaleString();
            document.getElementById('header-dist').innerText = `U[${minD}, ${maxD}]`;
            document.getElementById('current-session').innerText = currentSession;
        }

        function resetAiUI() {
            document.getElementById('ai-ask-btn').style.display = 'block';
            document.getElementById('ai-content').style.display = 'none';
            document.getElementById('ai-result').style.display = 'none';
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('loading-text').innerText = "ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘";
        }

        function startExperiment() {
            subjectId = document.getElementById('subject-id').value.trim();
            if (!subjectId) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            document.getElementById('instruction-section').style.display = 'none';
            document.getElementById('experiment-section').style.display = 'block';
            updateEnvironment();
            generateNewScenario();
            drawChart();
        }

        function generateNewScenario() {
            const actualDemand = Math.floor(Math.random() * (maxD - minD + 1)) + minD;
            window.currentScenario = { ai: optimalQ, actual: actualDemand };
            if (isAiRevealedThisSession) {
                document.getElementById('ai-ask-btn').style.display = 'none';
                document.getElementById('ai-content').style.display = 'flex';
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-result').style.display = 'block';
                document.getElementById('ai-prediction').innerText = optimalQ;
                document.getElementById('ai-reason-text').innerHTML = sessionAiReason;
            } else { resetAiUI(); }
            document.getElementById('order-qty').value = '';
            document.getElementById('order-qty').focus();
            document.getElementById('current-round-display').innerText = currentRoundInSession;
        }

        function revealAIAdvice() {
            isAiRevealedThisSession = true; 
            document.getElementById('ai-ask-btn').style.display = 'none';
            document.getElementById('ai-content').style.display = 'flex';
            setTimeout(() => { document.getElementById('loading-text').innerText = "í•´ë‹¹ ì„¸ì…˜ì˜ ìµœì  ìˆ˜ì¤€ ì‚°ì¶œ ì¤‘"; }, 2500);
            setTimeout(() => {
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-result').style.display = 'block';
                document.getElementById('ai-prediction').innerText = optimalQ;
                document.getElementById('ai-reason-text').innerHTML = sessionAiReason;
            }, 5000);
        }

        // [ì¶”ê°€] ë²”ìœ„ ì´íƒˆ ê²½ê³  í‘œì‹œ í•¨ìˆ˜
        function showWarning(text) {
            const warningEl = document.getElementById('warning-msg');
            warningEl.innerText = text;
            warningEl.style.opacity = "1";
            setTimeout(() => { warningEl.style.opacity = "0"; }, 3000); // 3ì´ˆ í›„ ì‚¬ë¼ì§
        }

        function submitOrder() {
            const qtyInput = document.getElementById('order-qty');
            const qty = parseInt(qtyInput.value);
            
            // [ìˆ˜ì •] ë²”ìœ„ ì´íƒˆ ì²´í¬ ë¡œì§
            if (isNaN(qty) || qty < 0) {
                showWarning("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                qtyInput.focus();
                return;
            }
            if (qty < minD || qty > maxD) {
                showWarning(`ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. (${minD} ~ ${maxD} ì‚¬ì´ ì…ë ¥ ê¶Œì¥)`);
                qtyInput.focus();
                return;
            }

            const demand = window.currentScenario.actual;
            const profit = (Math.min(qty, demand) * price) - (qty * cost);
            totalProfit += profit;
            localDataLog.push({
                subject_id: subjectId, session_number: currentSession, round_in_session: currentRoundInSession,
                total_round: totalRoundCount, cost: cost, ai_recommendation: optimalQ,
                user_order: qty, actual_demand: demand, profit: profit, accumulated_profit: totalProfit
            });
            const row = `<tr><td>${currentSession}</td><td>${currentRoundInSession}</td><td>${optimalQ}</td><td>${qty}</td><td>${demand}</td><td>${profit.toLocaleString()}</td></tr>`;
            document.getElementById('history-table-body').insertAdjacentHTML('afterbegin', row);
            document.getElementById('total-profit').innerText = totalProfit.toLocaleString();
            if (currentRoundInSession < roundsPerSession) {
                currentRoundInSession++; totalRoundCount++;
                document.getElementById('progress-bar').style.width = (totalRoundCount / 40 * 100) + "%";
                generateNewScenario(); drawChart();
            } else if (currentSession < totalSessions) {
                showSessionModal();
            } else { saveAllDataToSupabase(); }
        }

        function showSessionModal() {
            const costs = [3000, 9000, 3000, 9000];
            const distTexts = ["U[1, 100]", "U[1, 100]", "U[300, 500]", "U[300, 500]"];
            document.getElementById('modal-title').innerText = `ì„¸ì…˜ ${currentSession} ì™„ë£Œ`;
            const oldCost = costs[currentSession-1], newCost = costs[currentSession];
            const oldDist = distTexts[currentSession-1], newDist = distTexts[currentSession];
            const costBox = document.getElementById('cost-box');
            const distBox = document.getElementById('dist-box');
            if(oldCost === newCost) {
                costBox.innerHTML = `<span class="no-change">ë³€í™” ì—†ìŒ (${newCost.toLocaleString()}ì›)</span>`;
            } else {
                costBox.innerHTML = `<span class="old-val">${oldCost.toLocaleString()}ì›</span><span class="arrow">â”</span><span class="new-val">${newCost.toLocaleString()}ì›</span>`;
            }
            if(oldDist === newDist) {
                distBox.innerHTML = `<span class="no-change">ë³€í™” ì—†ìŒ (${newDist})</span>`;
            } else {
                distBox.innerHTML = `<span class="old-val">${oldDist}</span><span class="arrow">â”</span><span class="new-val">${newDist}</span>`;
            }
            document.getElementById('session-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('session-modal').style.display = 'none';
            currentSession++; currentRoundInSession = 1; totalRoundCount++;
            updateEnvironment(); generateNewScenario(); drawChart();
        }

        async function saveAllDataToSupabase() {
            const btn = document.getElementById('btn-submit');
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;
            const { error } = await _supabase.from('experiment_results').insert(localDataLog);
            if (error) { alert("ì €ì¥ ì‹¤íŒ¨: " + error.message); btn.disabled = false; }
            else { alert("âœ… ëª¨ë“  ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤í—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
        }

        function drawChart() {
            const canvas = document.getElementById('demandChart');
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.parentElement.clientWidth;
            const h = canvas.height = canvas.parentElement.clientHeight;
            const pad = 35;
            const xStep = (w - pad * 2) / 39;
            ctx.clearRect(0, 0, w, h);
            const sessionColors = ["#f8fafc", "#ffffff", "#f8fafc", "#ffffff"];
            for (let i = 0; i < currentSession; i++) {
                ctx.fillStyle = sessionColors[i];
                ctx.fillRect(pad + (i * 10 * xStep), 0, 10 * xStep, h);
            }
            const getY = (val, session) => {
                let currentMaxY = (session <= 2) ? 120 : 550;
                let currentMinY = (session <= 2) ? 0 : 250;
                return h - pad - ((val - currentMinY) / (currentMaxY - currentMinY) * (h - pad * 2));
            };
            ctx.strokeStyle = "#eee"; ctx.fillStyle = "#999"; ctx.font = "10px Arial";
            for(let v=0; v<=100; v+=50) {
                let y = getY(v, 1);
                ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(pad + 20 * xStep, y); ctx.stroke();
                ctx.fillText(v, 5, y+4);
            }
            if (currentSession >= 3) {
                for(let v=300; v<=500; v+=100) {
                    let y = getY(v, 3);
                    ctx.beginPath(); ctx.moveTo(pad + 20 * xStep, y); ctx.lineTo(w-pad, y); ctx.stroke();
                    ctx.fillText(v, w-pad+5, y+4);
                }
            }
            if (localDataLog.length === 0) return;
            const drawL = (key, col, dash) => {
                ctx.beginPath(); ctx.strokeStyle = col; ctx.setLineDash(dash ? [5, 5] : []);
                localDataLog.forEach((d, i) => {
                    const x = pad + (i * xStep);
                    const y = getY(d[key], d.session_number);
                    if (i === 0 || i === 10 || i === 20 || i === 30) ctx.moveTo(x, y); 
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            };
            drawL('actual_demand', "#1f2937", false);
            drawL('ai_recommendation', "#7c3aed", true);
            drawL('user_order', "#2563eb", false);
        }
    </script>
</body>
</html>
