<div class="header">
    <div class="round-info">ROUND <span id="current-round">1</span> / 15</div>
    <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
    <div class="score-info">ëˆ„ì  ìˆ˜ìµ: <span id="total-profit">0</span> ì›</div>
</div>

<div class="main-container">
    <div class="card">
        <h2>Decision Context</h2>
        <div style="background:#eff6ff; padding:15px; border-radius:8px; margin-bottom:20px;">
            <p>ğŸ›’ íŒë§¤ê°€: 12,000ì› | ğŸ“¦ ì›ê°€: 3,000ì›</p>
        </div>

        <div class="ai-advice-box">
            <span class="ai-badge">AI Advice</span>
            <div style="font-size: 1.1rem;">ì¶”ì²œ ì£¼ë¬¸ëŸ‰: <strong style="font-size: 1.6rem; color: #7c3aed;" id="ai-prediction">-</strong> ê°œ</div>
            <div class="ai-reason" id="ai-reason-text">ë°ì´í„° ë¶„ì„ ì¤‘...</div>
        </div>

        <div class="input-group">
            <input type="number" id="order-qty" placeholder="ìˆ˜ëŸ‰ ì…ë ¥">
            <button class="submit-btn" onclick="submitOrder()">ì£¼ë¬¸ ì œì¶œ (Submit)</button>
        </div>
    </div>

    <div class="card">
        <div class="chart-container"><canvas id="demandChart"></canvas></div>
        <div class="history-log">
            <table>
                <thead><tr><th>Rnd</th><th>AIì¶”ì²œ</th><th>ë‚´ì£¼ë¬¸</th><th>ìˆ˜ìš”</th><th>ì˜¤ì°¨</th><th>ìˆ˜ìµ</th></tr></thead>
                <tbody id="history-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // 1. Supabase ì„¤ì •
    const _supabase = supabase.createClient('https://rrbiyvcjtqvdfhudagnk.supabase.co', 'sb_publishable_pWpbnjDOm4LihZ8k720qhA_VPCRcCnV');

    // 2. ì‹¤í—˜ ì„¤ì •
    let currentRound = 1;
    const maxRounds = 15;
    let totalProfit = 0;
    const price = 12000, cost = 3000, salvage = 0;

    // URLì—ì„œ Prolific ID ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const prolificID = urlParams.get('prolific_pid') || "test_user_" + Math.floor(Math.random()*1000);

    const historyData = { rounds: [], aiPreds: [], userOrders: [], actualDemands: [] };

    // 3. ì‹¤ì œ ìˆ˜ìš” ìƒì„± ë¡œì§ (í‰ê·  150, í‘œì¤€í¸ì°¨ 30ì¸ ì •ê·œë¶„í¬ ê°€ì •)
    function getActualDemand() {
        const u1 = Math.random(), u2 = Math.random();
        const randStdNormal = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(2.0 * Math.PI * u2);
        return Math.round(150 + (30 * randStdNormal)); 
    }

    function generateNewScenario() {
        const actual = getActualDemand();
        // AIëŠ” ì‹¤ì œ ìˆ˜ìš”ì— ì•½ê°„ì˜ ì˜¤ì°¨(noise)ë¥¼ ë”í•´ ì¶”ì²œ
        const aiPred = Math.round(actual + (Math.random() * 20 - 10));
        
        document.getElementById('ai-prediction').innerText = aiPred;
        const reasons = ["ê³¼ê±° íŒ¨í„´ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.", "ì¬ê³  ë¶€ì¡± ìœ„í—˜ì„ ìµœì†Œí™”í•œ ìˆ˜ì¹˜ì…ë‹ˆë‹¤.", "ìˆ˜ìš” ë³€ë™ì„±ì„ ê³ ë ¤í•œ ìµœì ê°’ì…ë‹ˆë‹¤."];
        document.getElementById('ai-reason-text').innerText = reasons[Math.floor(Math.random() * reasons.length)];

        window.currentScenario = { ai: aiPred, actual: actual };
    }

    async function submitOrder() {
        const qty = parseInt(document.getElementById('order-qty').value);
        if (isNaN(qty) || qty < 0) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const demand = window.currentScenario.actual;
        const profit = (Math.min(qty, demand) * price) - (qty * cost);
        totalProfit += profit;

        historyData.rounds.push(currentRound);
        historyData.aiPreds.push(window.currentScenario.ai);
        historyData.userOrders.push(qty);
        historyData.actualDemands.push(demand);

        updateUI(qty, demand, profit);

        if (currentRound < maxRounds) {
            currentRound++;
            updateProgress();
            generateNewScenario();
            drawChart();
        } else {
            await saveToSupabase();
        }
    }

    async function saveToSupabase() {
        const { error } = await _supabase.from('experiment_results').insert([{
            prolific_id: prolificID,
            total_profit: totalProfit,
            user_orders: historyData.userOrders.toString(),
            actual_demands: historyData.actualDemands.toString(),
            ai_recommendations: historyData.aiPreds.toString()
        }]);

        if (error) {
            console.error(error);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ë°ì´í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìº¡ì²˜í•˜ì„¸ìš”.");
        } else {
            alert("ì‹¤í—˜ ì¢…ë£Œ! ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            // Prolific ì™„ë£Œ ì½”ë“œê°€ ìˆë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
            // window.location.href = "https://app.prolific.com/submissions/complete?cc=YOUR_CODE";
        }
    }

    function updateUI(order, actual, profit) {
        const tbody = document.getElementById('history-table-body');
        const row = `<tr><td>${currentRound}</td><td>${window.currentScenario.ai}</td><td>${order}</td><td>${actual}</td><td>${order-actual}</td><td>${profit.toLocaleString()}</td></tr>`;
        tbody.insertAdjacentHTML('afterbegin', row);
        document.getElementById('total-profit').innerText = totalProfit.toLocaleString();
    }

    function updateProgress() {
        document.getElementById('current-round').innerText = currentRound;
        document.getElementById('progress-bar').style.width = (currentRound/maxRounds*100) + "%";
    }

    // ì´ˆê¸° ì‹¤í–‰
    window.onload = () => { generateNewScenario(); drawChart(); };

    // (ì´ì „ drawChart ë¡œì§ í¬í•¨...)
    function drawChart() { /* ì´ì „ ë‹µë³€ì—ì„œ ë“œë¦° ê·¸ë¦¬ë“œ í¬í•¨ ì°¨íŠ¸ ì½”ë“œ */ }
</script>
